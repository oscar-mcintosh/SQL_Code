

	
	

--Population 2: Non-seasonal spenders
--Customers with a 20,30,40,50,60 % decrease in spend in the months of November and December for 2023/2024

-- this is how I account for months w/ 0 spend
WITH MONTHS AS (
    SELECT 1 AS mo UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL
    SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL
    SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL
    SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12
),
MONTHLY_SPEND AS (
    SELECT
        CLUB_ACCT_NK_SK,
        EXTRACT(YEAR FROM TRAN_DTE)::int AS yr,
        EXTRACT(MONTH FROM TRAN_DTE)::int AS mo,
        SUM(TRAN_AMT) AS TOTAL_SPEND
    FROM EDW_SPOKE.NZ.FACT_CLUB_CC_TRAN
    WHERE TRAN_DTE BETWEEN DATE '2023-01-01' AND DATE '2024-12-31'
    GROUP BY CLUB_ACCT_NK_SK, EXTRACT(YEAR FROM TRAN_DTE), EXTRACT(MONTH FROM TRAN_DTE)
),
PERCENT_DECREASE AS (
	SELECT
		CLUB_ACCT_NK_SK,
		YR,
		(AVG_SPEND_JAN_OCT - AVG_SPEND_NOV_DEC) / NULLIF(AVG_SPEND_JAN_OCT, 0) AS PCT_DECREASE
	FROM (
	    SELECT 
	        a.CLUB_ACCT_NK_SK,
	        ms.YR,
	        AVG(CASE WHEN m.mo BETWEEN 1 AND 10 
	        	THEN COALESCE(ms.TOTAL_SPEND,0) ELSE NULL END) AS AVG_SPEND_JAN_OCT,
	        AVG(CASE WHEN m.mo BETWEEN 11 AND 12 
	             THEN COALESCE(ms.TOTAL_SPEND,0) ELSE NULL END) AS AVG_SPEND_NOV_DEC
	    FROM (SELECT DISTINCT CLUB_ACCT_NK_SK FROM MONTHLY_SPEND) a    
	    CROSS JOIN MONTHS m
	    LEFT JOIN MONTHLY_SPEND ms
	      ON ms.CLUB_ACCT_NK_SK = a.CLUB_ACCT_NK_SK     
	     AND ms.mo = m.mo
	    GROUP BY a.CLUB_ACCT_NK_SK, ms.YR
    ) a
    WHERE a.AVG_SPEND_JAN_OCT > a.AVG_SPEND_NOV_DEC
),
BOTH_YEARS AS (
SELECT
 	pd2023.CLUB_ACCT_NK_SK,
 	pd2023.PCT_DECREASE AS PCT_2023,
 	pd2024.PCT_DECREASE AS PCT_2024,
 	DATE_OPENED
 FROM PERCENT_DECREASE pd2023
 JOIN PERCENT_DECREASE pd2024
 	ON pd2023.CLUB_ACCT_NK_SK = pd2024.CLUB_ACCT_NK_SK
 JOIN EDW_SPOKE..DIM_CLUB_ACCT a
	    ON pd2023.CLUB_ACCT_NK_SK = a.CLUB_ACCT_NK_SK
	JOIN (		
		SELECT AM00_ACCOUNT_IDENTIFIER AS TSYS_ACCT_ID
			, TO_DATE(SUBSTRING(AM00_DATE_ACCOUNT_OPEN, 1, 4) || '0101', 'YYYYMMDD') + TO_NUMBER(SUBSTRING(AM00_DATE_ACCOUNT_OPEN, 5, 3), '999') - 1 AS DATE_OPENED
		FROM EDW_HUB_STAGE..CURRENT_COF_AM00_DTL
		WHERE AM00_APPLICATION_SUFFIX = 0
		) d
		ON a.TSYS_ACCT_ID = d.TSYS_ACCT_ID
 	AND pd2023.YR = 2023
 	AND pd2024.YR = 2024
)
SELECT 
	COUNT(DISTINCT CASE WHEN PCT_2023 >= 0.2 AND PCT_2024 >= 0.2 THEN ENT_CUSTOMER_ID END) AS CNT_20PCT,
	COUNT(DISTINCT CASE WHEN PCT_2023 >= 0.3 AND PCT_2024 >= 0.3 THEN ENT_CUSTOMER_ID END) AS CNT_30PCT,
	COUNT(DISTINCT CASE WHEN PCT_2023 >= 0.4 AND PCT_2024 >= 0.4 THEN ENT_CUSTOMER_ID END) AS CNT_40PCT,
	COUNT(DISTINCT CASE WHEN PCT_2023 >= 0.5 AND PCT_2024 >= 0.5 THEN ENT_CUSTOMER_ID END) AS CNT_50PCT,
	COUNT(DISTINCT CASE WHEN PCT_2023 >= 0.6 AND PCT_2024 >= 0.6 THEN ENT_CUSTOMER_ID END) AS CNT_60PCT
FROM BOTH_YEARS a 
JOIN EDW_SPOKE..DIM_CLUB_ACCT b
    ON a.CLUB_ACCT_NK_SK = b.CLUB_ACCT_NK_SK
	 AND a.DATE_OPENED::DATE < DATE '2023-01-01'
	 AND b.END_DTE IS NULL
	 AND COALESCE(b.CLOSED_RSN_CD, '') = ''		-- Exclude closed accounts
     AND COALESCE(b.CHRG_OFF_RSN_CD, '') = ''	-- Exclude charged-off accounts
     AND COALESCE(b.CLUB_MKT_OPT_OUT, '') <> 'Y'	-- Exclude opt-outs
JOIN EDW_SPOKE..FACT_CLUB_ACCT_SUMM_HIST c
    ON b.CLUB_ACCT_NK_SK = c.CLUB_ACCT_NK_SK	
	 AND c.END_DTE IS NULL
     AND COALESCE(c.AUTH_PROHIBIT_RSN_CD, '') <> 'A7'	-- Exclude fraud accounts
     AND COALESCE(c.PAST_DUE_CD, '') = ''		-- Exclude past-dues	
JOIN EDW_SPOKE.ADMIN.DIM_CLUB_CUST e 
    ON b.CLUB_ACCT_NK_SK = e.CLUB_ACCT_NK_SK 
JOIN EDW_HUB_STAGE..CURRENT_COF_CUST_XREF_DTL f
    ON e.TSYS_CUST_ID = f.CUSTOMER_ID    	
    AND e.END_DTE IS NULL;
