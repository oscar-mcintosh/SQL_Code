--Ask: 2025 vs 2024 YOY spend and/or transactions decline by XX%

WITH MONTHS AS (
    SELECT 1 AS mo UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL
    SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL
    SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL
    SELECT 10 UNION ALL SELECT 11 UNION ALL SELECT 12
),
ELIGIBLE_ACCTS AS (
    SELECT DISTINCT
        b.CLUB_ACCT_NK_SK,
        f.ENT_CUSTOMER_ID
    FROM EDW_SPOKE..DIM_CLUB_ACCT b
    JOIN EDW_SPOKE..FACT_CLUB_ACCT_SUMM_HIST c
      ON b.CLUB_ACCT_NK_SK = c.CLUB_ACCT_NK_SK
      AND b.END_DTE IS NULL
      AND COALESCE(b.CLOSED_RSN_CD, '') = ''           -- Exclude closed accounts
      AND COALESCE(b.CHRG_OFF_RSN_CD, '') = ''         -- Exclude charged-off accounts
      AND COALESCE(b.CLUB_MKT_OPT_OUT, '') <> 'Y'      -- Exclude opt-outs
      AND c.END_DTE IS NULL
      AND COALESCE(c.AUTH_PROHIBIT_RSN_CD, '') <> 'A7' -- Exclude fraud accounts
      AND COALESCE(c.PAST_DUE_CD, '') = ''             -- Exclude past-dues
      AND CLI_PROD_CD <> '185'
    JOIN EDW_SPOKE.ADMIN.DIM_CLUB_CUST e
      ON b.CLUB_ACCT_NK_SK = e.CLUB_ACCT_NK_SK      
      AND e.END_DTE IS NULL
    JOIN EDW_HUB_STAGE..CURRENT_COF_CUST_XREF_DTL f
      ON e.TSYS_CUST_ID = f.CUSTOMER_ID
    JOIN (
        SELECT
            AM00_ACCOUNT_IDENTIFIER AS TSYS_ACCT_ID,
            TO_DATE(SUBSTRING(AM00_DATE_ACCOUNT_OPEN, 1, 4) || '0101', 'YYYYMMDD')
              + TO_NUMBER(SUBSTRING(AM00_DATE_ACCOUNT_OPEN, 5, 3), '999') - 1 AS DATE_OPENED
        FROM EDW_HUB_STAGE..CURRENT_COF_AM00_DTL
        WHERE AM00_APPLICATION_SUFFIX = 0
    ) d
      ON b.TSYS_ACCT_ID = d.TSYS_ACCT_ID   
      AND d.DATE_OPENED::DATE < DATE '2024-01-01'      
),
CUSTOMER_MONTHLY_SPEND AS (
    SELECT
        ea.ENT_CUSTOMER_ID,
        EXTRACT(YEAR  FROM t.TRAN_DTE)::int AS yr,
        EXTRACT(MONTH FROM t.TRAN_DTE)::int AS mo,
        SUM(t.TRAN_AMT) AS TOTAL_SPEND
    FROM EDW_SPOKE.NZ.FACT_CLUB_CC_TRAN t
    JOIN ELIGIBLE_ACCTS ea
      ON t.CLUB_ACCT_NK_SK = ea.CLUB_ACCT_NK_SK
    WHERE t.TRAN_DTE BETWEEN DATE '2024-01-01' AND DATE '2025-12-31'
    GROUP BY
        ea.ENT_CUSTOMER_ID,
        EXTRACT(YEAR  FROM t.TRAN_DTE),
        EXTRACT(MONTH FROM t.TRAN_DTE)
),
CUSTOMER_MONTH_GRID AS (
    SELECT
        c.ENT_CUSTOMER_ID,
        y.yr,
        m.mo
    FROM (SELECT DISTINCT ENT_CUSTOMER_ID FROM CUSTOMER_MONTHLY_SPEND) c
    CROSS JOIN (SELECT 2024 AS yr UNION ALL SELECT 2025) y
    CROSS JOIN MONTHS m
),
CUSTOMER_YEAR_AVG AS (
    SELECT
        g.ENT_CUSTOMER_ID,
        g.yr,
        ROUND(AVG(COALESCE(ms.TOTAL_SPEND, 0)),0) AS AVG_MONTHLY_SPEND
    FROM CUSTOMER_MONTH_GRID g
    LEFT JOIN CUSTOMER_MONTHLY_SPEND ms
      ON ms.ENT_CUSTOMER_ID = g.ENT_CUSTOMER_ID
     AND ms.yr = g.yr
     AND ms.mo = g.mo
    GROUP BY g.ENT_CUSTOMER_ID, g.yr
),
CUSTOMER_YOY AS (
    SELECT
        a.ENT_CUSTOMER_ID,
        a.AVG_MONTHLY_SPEND AS AVG_2024,
        b.AVG_MONTHLY_SPEND AS AVG_2025,
        (a.AVG_MONTHLY_SPEND - b.AVG_MONTHLY_SPEND) / NULLIF(a.AVG_MONTHLY_SPEND, 0) AS YOY_PCT_DECLINE
    FROM CUSTOMER_YEAR_AVG a
    JOIN CUSTOMER_YEAR_AVG b
      ON a.ENT_CUSTOMER_ID = b.ENT_CUSTOMER_ID
     AND a.yr = 2024
     AND b.yr = 2025
    WHERE a.AVG_MONTHLY_SPEND > 0
      AND a.AVG_MONTHLY_SPEND > b.AVG_MONTHLY_SPEND   -- decline only
)
SELECT *
FROM CUSTOMER_YOY;
